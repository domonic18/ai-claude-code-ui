# 多账户设置与 MCP 服务需求文档

## 1. 概述

本文档描述了多账户模式下 Claude Code 设置和 MCP 服务的功能需求。系统需要支持每个用户独立配置自己的 Claude Code 设置和 MCP 服务，并在容器内的 Claude Code 中生效。

## 2. 用户 Claude Code 设置需求

### 2.1 功能描述

每个账户可以独立配置自己的 Claude Code 设置，这些设置应该在容器内的 Claude Code 执行时生效。

### 2.2 设置项

| 设置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| Allowed Tools | 数组 | 默认工具列表 | 允许 Claude Code 使用的工具列表 |
| Disallowed Tools | 数组 | 空 | 禁止 Claude Code 使用的工具列表 |
| Skip permission prompts | 布尔值 | true | 是否跳过权限提示（危险操作） |

### 2.3 默认工具列表

当用户未配置 Allowed Tools 时，系统应该使用以下默认工具列表：

```
Bash(git log:*)
Bash(git diff:*)
Bash(git status:*)
Write
Read
Edit
Glob
Grep
MultiEdit
Task
TodoWrite
TodoRead
WebFetch
WebSearch
```

### 2.4 权限模式说明

| 模式 | Skip permission prompts | 行为 |
|------|------------------------|------|
| Bypass Permissions | true | 所有工具直接使用，无需用户确认 |
| Default | false | 需要根据 Allowed Tools 配置来判断 |

### 2.5 设置范围

设置应该与账户绑定，具体要求：

- 每个用户有自己独立的设置
- 设置不应该在不同用户之间共享
- 用户在不同设备/浏览器登录时应该看到相同的设置
- 设置应该持久化存储在服务器端

## 3. MCP 服务配置需求

### 3.1 功能描述

每个账户可以配置自己的 MCP (Model Context Protocol) 服务，并在容器内的 Claude Code 中使用这些服务。

### 3.2 MCP 服务操作

用户需要能够对 MCP 服务进行以下操作：

| 操作 | 说明 |
|------|------|
| 新增 | 添加新的 MCP 服务配置 |
| 编辑 | 修改现有 MCP 服务配置 |
| 删除 | 删除不再使用的 MCP 服务 |
| 查询 | 查看已配置的 MCP 服务列表 |
| 测试 | 测试 MCP 服务连接是否正常 |
| 工具发现 | 查看 MCP 服务提供的可用工具 |

### 3.3 MCP 服务配置项

每个 MCP 服务应包含以下配置：

| 配置项 | 类型 | 说明 |
|--------|------|------|
| name | 字符串 | MCP 服务名称（唯一标识） |
| type | 枚举 | 服务类型：stdio、http、sse |
| command | 字符串 | 启动命令（stdio 类型） |
| args | 数组 | 命令参数（stdio 类型） |
| url | 字符串 | 服务 URL（http/sse 类型） |
| env | 对象 | 环境变量（可选） |

### 3.4 MCP 服务范围

MCP 服务配置应该与账户绑定，具体要求：

- 每个用户只能看到和配置自己的 MCP 服务
- 不同用户的 MCP 服务配置相互隔离
- 用户 A 不能访问用户 B 的 MCP 服务
- MCP 服务配置应该持久化存储在服务器端

## 4. 容器集成需求

### 4.1 设置生效

容器内的 Claude Code 执行时，应该：

1. 读取当前用户的设置配置
2. 根据设置的 Allowed Tools 配置工具权限
3. 根据设置的 Disallowed Tools 禁用相应工具
4. 根据 Skip permission prompts 设置权限模式

### 4.2 MCP 服务可用性

容器内的 Claude Code 应该能够：

1. 访问当前用户配置的 MCP 服务
2. 调用 MCP 服务提供的工具
3. 从 MCP 服务获取数据或执行操作
4. 处理 MCP 服务返回的结果

### 4.3 隔离要求

- 用户 A 的容器只能访问用户 A 的设置和 MCP 服务
- 用户 B 的容器只能访问用户 B 的设置和 MCP 服务
- 容器之间的 MCP 服务应该完全隔离

## 5. 界面需求

### 5.1 Settings 对话框

在现有的 Settings 对话框中，应该能够：

- 查看当前的 Claude Code 设置
- 修改 Allowed Tools 列表
- 修改 Disallowed Tools 列表
- 切换 Skip permission prompts 选项
- 保存设置到服务器

### 5.2 MCP 服务管理

在 Settings 对话框的 MCP Servers 标签页中，应该能够：

- 查看已配置的 MCP 服务列表
- 添加新的 MCP 服务（支持表单和 JSON 导入）
- 编辑现有 MCP 服务
- 删除 MCP 服务
- 测试 MCP 服务连接
- 查看 MCP 服务提供的工具列表

## 6. 数据持久化需求

### 6.1 设置存储

用户设置应该存储在服务器端的数据库中，与用户账户关联。

### 6.2 MCP 服务存储

MCP 服务配置应该存储在服务器端的数据库中，与用户账户关联。

### 6.3 数据同步

- 用户在不同客户端登录时，应该能看到相同的设置和 MCP 服务
- 设置和 MCP 服务的修改应该实时同步到服务器
- 多个客户端同时登录时，修改应该能够同步到其他客户端

## 7. 安全需求

### 7.1 访问控制

- 用户只能访问和修改自己的设置
- 用户只能访问和修改自己的 MCP 服务
- API 应该验证用户身份，防止跨用户访问

### 7.2 数据隔离

- 不同用户的数据应该完全隔离
- 容器之间的数据应该完全隔离
- MCP 服务之间的数据应该完全隔离

## 8. 非功能需求

### 8.1 性能

- 设置读取应该快速响应（< 100ms）
- MCP 服务列表加载应该快速响应（< 500ms）
- 容器启动时应该能够快速加载用户的设置和 MCP 服务

### 8.2 可靠性

- 设置保存不应该丢失
- MCP 服务配置保存不应该丢失
- 系统应该能够处理并发修改

### 8.3 可扩展性

- 系统应该支持大量用户配置
- 系统应该支持大量 MCP 服务配置
- 系统应该易于添加新的设置项

## 9. 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| 1.0 | 2025-01-15 | - | 初始版本 |

# 多用户 Claude Code 系统 - 架构概述

> **文档版本**: 1.0
> **创建时间**: 2026-01-10
> **方案类型**: Docker + Seccomp 容器隔离
> **项目版本**: 基于 main 分支

---

## 目录

- [一、架构概述](#一架构概述)
- [二、整体架构设计](#二整体架构设计)
- [三、实施计划](#三实施计划)
- [四、附录](#四附录)

---

## 一、架构概述

### 1.1 设计目标

将当前的单用户 Claude Code 执行系统改造为**多用户容器隔离系统**，实现：

1. **用户间完全隔离**：每个用户拥有独立的执行环境
2. **宿主机安全保护**：防止用户代码逃逸沙箱威胁宿主机
3. **资源可控**：CPU、内存、磁盘等资源可限制
4. **高可用性**：支持容器故障恢复和自动重启
5. **可扩展性**：支持横向扩展和负载均衡

### 1.2 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| 容器运行时 | Docker 24.x | 成熟稳定的容器技术 |
| 安全策略 | Seccomp + AppArmor | 系统调用过滤和强制访问控制 |
| 容器编排 | Docker Compose (起步) | 简化部署和管理 |
| 网络隔离 | Docker Bridge + User Network | 容器间网络隔离 |
| 存储卷 | Docker Volume | 持久化用户数据 |
| 容器管理 | Dockerode (Node.js) | Docker API 封装 |

### 1.3 架构原则

- **最小权限原则**：容器仅拥有执行任务所需的最小权限
- **防御深度原则**：多层安全防护（容器+Seccomp+AppArmor+网络隔离）
- **故障隔离原则**：单个容器故障不影响其他用户
- **资源配额原则**：严格限制每个用户的资源使用

---

## 二、整体架构设计

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              宿主机 (Host Machine)                            │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    主应用 (Express + React)                            │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │  │
│  │  │  HTTP Server   │  │ WebSocket (ws) │  │  SQLite DB     │          │  │
│  │  │   (Express)    │  │                │  │  (用户认证)     │          │  │
│  │  └────────┬───────┘  └───────┬────────┘  └────────────────┘          │  │
│  └───────────┼──────────────────┼───────────────────────────────────────┘  │
│              │                  │                                              │
│  ┌───────────▼──────────────────▼───────────────────────────────────────┐  │
│  │              容器管理中间层 (Container Management Layer)              │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │           ContainerManager (server/container-manager.js)        │  │
│  │  │  - 容器生命周期管理                                              │  │
│  │  │  - 容器池管理                                                     │  │
│  │  │  - 资源监控和配额                                                 │  │
│  │  └────────────────────┬───────────────────────────────────────────┘  │  │
│  └───────────────────────┼──────────────────────────────────────────────┘  │
│                          │                                                   │
│              ┌───────────┼───────────┐                                       │
│              │           │           │
│  ┌───────────▼──┐  ┌────▼─────┐  ┌─▼──────────┐
│  │  用户A容器    │  │ 用户B容器 │  │  用户C容器   │
│  │  ┌────────┐  │  │ ┌──────┐ │  │  ┌───────┐  │
│  │  │node-pty│  │  │ │node- │ │  │  │node-  │  │
│  │  │(终端)  │  │  │ │pty   │ │  │  │pty    │  │
│  │  └────────┘  │  │ └──────┘ │  │  └───────┘  │
│  │  ┌────────┐  │  │ ┌──────┐ │  │  ┌───────┐  │
│  │  │Claude  │  │  │ │Claude│ │  │  │Claude │  │
│  │  │SDK     │  │  │ │SDK   │ │  │  │SDK    │  │
│  │  └────────┘  │  │ └──────┘ │  │  └───────┘  │
│  │  ┌────────┐  │  │ ┌──────┐ │  │  ┌───────┐  │
│  │  │/workspace│ │  │ │/work-│ │  │  │/work-  │  │
│  │  │(用户A)  │  │  │ │space │ │  │  │space   │  │
│  │  └────────┘  │  │ │(用户B)│ │  │  │(用户C)  │  │
│  └──────────────┘  │ └──────┘ │  │  └───────┘  │
│                    └──────────┘  └─────────────┘
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      Docker Daemon                                     │  │
│  │  - 容器创建/启动/停止                                                   │
│  │  - 镜像管理                                                            │
│  │  - 网络管理                                                            │
│  │  - 存储卷管理                                                          │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 分层架构说明

#### 2.2.1 应用层 (Application Layer)

**主应用**：保持现有的 Express + React 架构

- **HTTP Server**：处理 REST API 请求
- **WebSocket Server**：处理实时通信（聊天和终端）
- **SQLite DB**：用户认证和会话管理

**主要文件**：
- `server/index.js` - 主服务入口
- `server/claude-sdk.js` - Claude SDK 集成（需改造）
- `server/routes/*` - API 路由

#### 2.2.2 容器管理层 (Container Management Layer)

**新增模块**：负责容器生命周期管理

**核心模块**：`server/container-manager.js`

```javascript
class ContainerManager {
  // 容器池管理
  containerPool: Map<userId, containerInfo>

  // 核心方法
  async getOrCreateContainer(userId, userTier)
  async destroyContainer(userId)
  async executeInContainer(userId, command)
  async getContainerStats(userId)
  async cleanupIdleContainers()
}
```

#### 2.2.3 容器执行层 (Container Execution Layer)

**用户容器**：每个用户的独立执行环境

**容器内容**：
- **node-pty**：终端进程
- **Claude SDK**：AI 代理执行
- **工作目录**：`/workspace` (用户专属文件系统)
- **运行时**：Node.js 20.x

### 2.3 通信流程图

```
┌──────────┐         ┌──────────────┐         ┌─────────────┐
│ 前端用户   │ ──────▶│  主应用       │ ──────▶│  用户容器     │
│ (Browser) │         │  (Express)   │         │  (Docker)   │
└──────────┘         └──────────────┘         └─────────────┘
     │                      │                         │
     │  1. WebSocket 连接     │                         │
     ├────────────────────▶│                         │
     │                      │                         │
     │                      │  2. 获取/创建容器         │
     │                      ├─────────────────────▶│
     │                      │                         │
     │                      │  3. 容器就绪响应         │
     │                      │◀─────────────────────┤
     │                      │                         │
     │  4. 发送命令/输入      │                         │
     ├────────────────────▶│                         │
     │                      │  5. 转发到容器           │
     │                      ├─────────────────────▶│
     │                      │                         │
     │                      │  6. 容器内执行           │
     │                      │  (Claude SDK / PTY)     │
     │                      │                         │
     │                      │  7. 流式输出响应         │
     │                      │◀─────────────────────┤
     │  8. 流式响应前端      │                         │
     │◀─────────────────────┤                         │
     │                      │                         │
```

---

## 三、实施计划

### 3.1 分阶段实施路线

```
┌─────────────────────────────────────────────────────────┐
│                    实施路线图                             │
└─────────────────────────────────────────────────────────┘

阶段 1: 基础设施准备 (1-2 周)
├── 宿主机环境配置
│   ├── 安装 Docker 24.x
│   ├── 配置 Docker Daemon
│   ├── 配置 Seccomp 策略
│   └── 配置 AppArmor 配置
├── 构建容器镜像
│   ├── 编写 Dockerfile
│   ├── 测试容器镜像
│   └── 推送到镜像仓库
└── 数据库准备
    ├── 扩展数据库表结构
    └── 数据迁移脚本

阶段 2: 核心功能开发 (2-3 周)
├── 容器管理器开发
│   ├── ContainerManager 类
│   ├── 容器生命周期管理
│   ├── 资源限制配置
│   └── 容器池管理
├── Claude SDK 容器化
│   ├── 改造 claude-sdk.js
│   ├── 容器内执行逻辑
│   └── 流式输出处理
└── PTY 容器化
    ├── 改造 shell 连接处理
    ├── 容器内 PTY 创建
    └── 会话管理

阶段 3: 文件操作容器化 (1-2 周)
├── 文件读取改造
├── 文件保存改造
├── 文件树获取改造
└── 路径安全验证

阶段 4: 安全加固 (1 周)
├── Seccomp 策略优化
├── AppArmor 配置
├── 网络隔离配置
└── 资源限制调优

阶段 5: 测试与优化 (1-2 周)
├── 功能测试
│   ├── 单用户测试
│   ├── 多用户并发测试
│   └── 容器隔离测试
├── 性能测试
│   ├── 容器启动时间
│   ├── 执行性能
│   └── 资源使用
└── 安全测试
    ├── 容器逃逸测试
    ├── 资源限制测试
    └── 网络隔离测试

阶段 6: 部署与监控 (1 周)
├── 生产环境部署
├── 监控系统搭建
├── 日志聚合配置
└── 告警规则配置

总计: 7-11 周
```

### 3.2 关键里程碑

| 里程碑 | 交付物 | 验收标准 |
|--------|--------|---------|
| M1: 基础设施就绪 | Docker 环境配置完成 | 可在宿主机上运行容器 |
| M2: 容器管理器完成 | ContainerManager 模块 | 可通过 API 创建/销毁容器 |
| M3: SDK 容器化完成 | Claude SDK 容器化版本 | 可在容器内执行 Claude 命令 |
| M4: PTY 容器化完成 | PTY 容器化版本 | 可在容器内创建终端会话 |
| M5: 文件操作完成 | 文件操作容器化版本 | 可通过容器读写文件 |
| M6: 安全加固完成 | 安全策略配置 | 通过安全测试 |
| M7: 生产部署完成 | 生产环境运行 | 多用户可正常使用 |

### 3.3 风险与缓解措施

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| Docker API 兼容性问题 | 中 | 中 | 使用稳定版本的 Docker，进行充分测试 |
| 容器性能开销 | 高 | 中 | 进行性能基准测试，优化资源分配 |
| 容器逃逸漏洞 | 低 | 高 | 定期更新 Docker，使用 Seccomp/AppArmor |
| 存储卷管理复杂 | 中 | 中 | 使用 Docker Volume，编写管理脚本 |
| 网络配置问题 | 中 | 低 | 简化网络配置，使用默认 bridge 网络 |
| 资源限制失效 | 中 | 中 | 使用 cgroups v2，监控资源使用 |

### 3.4 回滚计划

```
如果容器化方案出现问题，可以按以下步骤回滚：

1. 停止创建新容器
   - 禁用 ContainerManager
   - 切换到直接执行模式

2. 迁移现有用户
   - 从容器卷导出用户数据
   - 恢复到宿主机目录

3. 恢复原有代码
   - 切换到容器化前的代码分支
   - 重启应用服务

4. 清理容器资源
   - 停止并删除所有用户容器
   - 删除用户网络
   - 删除 Docker Volume

预计回滚时间: 2-4 小时
```

### 3.5 成功标准

```
功能指标:
✓ 每个用户拥有独立的容器环境
✓ 容器间完全隔离，无法互相访问
✓ Claude SDK 可在容器内正常运行
✓ 终端 (PTY) 可在容器内正常工作
✓ 文件操作通过容器进行
✓ 容器资源限制生效

性能指标:
✓ 容器启动时间 < 5 秒
✓ 命令执行延迟增加 < 20%
✓ 内存开销增加 < 10%
✓ 支持至少 20 个并发用户

安全指标:
✓ 通过 Seccomp 策略限制危险系统调用
✓ 通过 AppArmor 限制文件访问
✓ 容器无法访问宿主机 Docker Socket
✓ 容器网络隔离生效
✓ 资源限制防止资源滥用

可靠性指标:
✓ 容器故障不影响其他用户
✓ 容器可自动重启恢复
✓ 用户数据持久化正常
✓ 日志完整可追踪
```

---

## 四、附录

### 4.1 相关文档

- [多用户沙箱隔离方案评估报告](./multi-user-sandbox-evaluation.md)
- [数据存储设计](./data-storage-design.md)
- [核心模块设计](./core-modules-design.md)
- [安全与部署配置](./security-deployment-config.md)
- [项目结构说明](../ai-context/project-structure.md)
- [API 文档](../api/README.md)

### 4.2 参考资源

#### Docker 官方文档
- [Docker API Reference](https://docs.docker.com/engine/api/latest/)
- [Docker Security](https://docs.docker.com/engine/security/)
- [Docker Seccomp](https://docs.docker.com/engine/security/seccomp/)

#### Node.js Docker 库
- [Dockerode Documentation](https://github.com/apocas/dockerode)
- [Dockerode Examples](https://github.com/apocas/dockerode/tree/master/examples)

#### 安全最佳实践
- [Docker Security Best Practices](https://snyk.io/blog/10-docker-image-security-best-practices/)
- [Container Security Checklist](https://github.com/konstruktoid/Security)

### 4.3 术语表

| 术语 | 说明 |
|------|------|
| **Container** | Docker 容器，轻量级虚拟化技术 |
| **Seccomp** | Linux 系统调用过滤机制 |
| **AppArmor** | Linux 强制访问控制系统 |
| **Volume** | Docker 数据卷，用于数据持久化 |
| **PTY** | 伪终端，用于终端模拟 |
| **cgroups** | Linux 控制组，用于资源限制 |
| **namespace** | Linux 命名空间，用于资源隔离 |
| **Dockerode** | Node.js 的 Docker API 客户端库 |

---

**文档维护**

本文档应该根据实际实施情况持续更新。如有任何疑问或建议，请联系项目维护者。

**版本历史**

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | 2026-01-10 | Claude | 初始版本 |
